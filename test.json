{
  "name": "Phishing Detection for Chrome Extension (with AI)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "phish-check",
        "responseMode": "onReceived"
      },
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 200]
    },
    {
      "parameters": {
        "values": {
          "string": [
            { "name": "url", "value": "={{ $json.url || $json.inputUrl }}" },
            { "name": "hostname", "value": "={{ $helper.getHostname($json.url || $json.inputUrl) }}" }
          ]
        }
      },
      "name": "Set URL & Hostname",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [460, 200]
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "=https://safebrowsing.googleapis.com/v4/threatMatches:find?key={{ $env.GOOGLE_SAFE_BROWSING_API_KEY }}",
        "jsonParameters": true,
        "bodyParametersJson": "={ \"client\": { \"clientId\": \"n8n-phish-check\", \"clientVersion\": \"1.0\" }, \"threatInfo\": { \"threatTypes\": [\"MALWARE\",\"SOCIAL_ENGINEERING\",\"UNWANTED_SOFTWARE\"], \"platformTypes\": [\"ANY_PLATFORM\"], \"threatEntryTypes\": [\"URL\"], \"threatEntries\": [{ \"url\": $json.url }] } }"
      },
      "name": "Google Safe Browsing",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [700, 40]
    },
    {
      "parameters": {
        "requestMethod": "GET",
        "url": "https://check.phishtank.com/checkurl/",
        "queryParametersUi": { "parameter": [ { "name": "format", "value": "json" }, { "name": "url", "value": "={{ $json.url }}" } ] }
      },
      "name": "PhishTank Lookup",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [700, 160]
    },
    {
      "parameters": {
        "requestMethod": "GET",
        "url": "=https://www.virustotal.com/api/v3/urls/{{ Buffer.from($json.url).toString('base64').replace(/=+$/, '') }}",
        "responseFormat": "json"
      },
      "name": "VirusTotal URL Check",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [700, 280],
      "credentials": { "httpHeaderAuth": { "id": "", "name": "VirusTotal Header" } }
    },
    {
      "parameters": {
        "requestMethod": "GET",
        "url": "=https://api.whois.example/whois/{{ $json.hostname }}",
        "responseFormat": "json"
      },
      "name": "WHOIS / Domain Info (placeholder)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [700, 400]
    },
    {
      "parameters": {
        "requestMethod": "GET",
        "url": "={{ 'https://' + $json.hostname }}",
        "responseFormat": "string",
        "options": { "followRedirect": true, "allowUnauthorizedCerts": false }
      },
      "name": "Fetch Page HTML",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [700, 520]
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={ \n  \"model\": \"gpt-4o-mini\",\n  \"messages\": [\n    { \"role\": \"system\", \"content\": \"You are a security assistant. Given structured signals about a URL, respond with a JSON object containing: {\\\"ai_score\\\": number 0-100, \\\"ai_explanation\\\": string, \\\"details\\\": { ... } }. Do NOT add extra text outside the JSON. Keep the JSON valid.\\n\\nUse the data provided in the user message to evaluate whether the site is phishing/fake, and justify with observations (e.g., "domain age", "forms", "tls", "similarity to brand").\" },\n    { \"role\": \"user\", \"content\": \"Analyze this URL and signals as JSON: { \\\"url\\\": \"" + $json.url + "\", \\\"safebrowsing\\\": " + JSON.stringify($items(\"Google Safe Browsing\")[0]?.json || {}) + ", \\\"phishtank\\\": " + JSON.stringify($items(\"PhishTank Lookup\")[0]?.json || {}) + ", \\\"virustotal\\\": " + JSON.stringify($items(\"VirusTotal URL Check\")[0]?.json || {}) + ", \\\"whois\\\": " + JSON.stringify($items(\"WHOIS / Domain Info (placeholder)\")[0]?.json || {}) + ", \\\"htmlSnippet\\\": \"" + ( ($items(\"Fetch Page HTML\")[0]?.json || '').toString().slice(0,2000).replace(/\"/g, "\\\"") ) + "\" }\" }\n  ]\n}"
      },
      "name": "AI Model Check (OpenAI)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [700, 680],
      "credentials": { "httpHeaderAuth": { "id": "", "name": "OpenAI Header" } }
    },
    {
      "parameters": {
        "functionCode": "// Consolidate signals from previous nodes and compute a phish_score (0-100) using AI score as one input\nconst sb = $items(\"Google Safe Browsing\")[0]?.json || {};\nconst pt = $items(\"PhishTank Lookup\")[0]?.json || {};\nconst vt = $items(\"VirusTotal URL Check\")[0]?.json || {};\nconst whois = $items(\"WHOIS / Domain Info (placeholder)\")[0]?.json || {};\nconst html = $items(\"Fetch Page HTML\")[0]?.json || '';
const aiRaw = $items("AI Model Check (OpenAI)")[0]?.json || {};
let ai_score = null;
let ai_explanation = null;
try {
  // OpenAI returns choices[0].message.content containing the JSON we requested
  const content = aiRaw.choices && aiRaw.choices[0] && aiRaw.choices[0].message && aiRaw.choices[0].message.content;
  if (content) {
    // attempt to extract JSON from the model output
    const firstBrace = content.indexOf('{');
    const lastBrace = content.lastIndexOf('}');
    const jsonText = firstBrace !== -1 && lastBrace !== -1 ? content.slice(firstBrace, lastBrace+1) : content;
    const parsed = JSON.parse(jsonText);
    ai_score = parsed.ai_score;
    ai_explanation = parsed.ai_explanation || parsed.analysis || JSON.stringify(parsed.details || {});
  }
} catch (e) {
  // parsing failed: store raw content
  ai_explanation = aiRaw.choices && aiRaw.choices[0] && aiRaw.choices[0].message ? aiRaw.choices[0].message.content : JSON.stringify(aiRaw);
}

let score = 0; const reasons = [];
// Safe Browsing: immediate block
if (sb && Object.keys(sb).length > 0) { score = 100; reasons.push('Listed on Google Safe Browsing'); }
// PhishTank
if (pt && (pt.valid || pt.in_database || pt.exists || pt.phish)) { score = Math.max(score, 95); reasons.push('Found in PhishTank'); }
// VirusTotal
try {
  const stats = vt?.data?.attributes?.last_analysis_stats;
  if (stats) {
    if (stats.malicious && stats.malicious > 0) { score = Math.max(score, 95); reasons.push('VirusTotal: malicious engines flagged'); }
    else if (stats.suspicious && stats.suspicious > 0) { score += 40; reasons.push('VirusTotal: suspicious engines flagged'); }
  }
} catch(e){}
// WHOIS
try {
  const created = whois?.createdDate || whois?.creation_date || whois?.created;
  if (created) {
    const ageDays = Math.floor((Date.now() - new Date(created)) / (1000*60*60*24));
    if (ageDays < 30) { score += 25; reasons.push('Domain age < 30 days'); }
    else if (ageDays < 180) { score += 10; reasons.push('Domain age < 180 days'); }
  }
} catch(e){}
// TLS
const inputUrl = $json.url || $json.inputUrl || '';
if (!inputUrl.toLowerCase().startsWith('https://')) { score += 30; reasons.push('No HTTPS'); }
// HTML heuristics
try {
  const htmlLower = (html || '').toLowerCase();
  if (/<form[\\s\\S]*action=\\\"https?:\\\/\\\//.test(htmlLower) && !htmlLower.includes($json.hostname)) { score += 20; reasons.push('Form posts to external domain'); }
  if (/(enter your password|verify your account|update your payment|confirm your identity)/.test(htmlLower)) { score += 15; reasons.push('Urgent credential request language'); }
} catch(e){}

// Integrate AI score if present (weight it moderately)
if (typeof ai_score === 'number') {
  // normalize to 0-100 and blend: we'll average weighted 40% AI, 60% other signals
  // compute non-AI partial: nonAiScore is current 'score' mapped to 0-100 clamped
  let nonAiScore = Math.min(100, Math.max(0, score));
  // blended
  const blended = Math.round((0.6 * nonAiScore) + (0.4 * ai_score));
  score = blended;
  reasons.push('Blended AI score: ' + ai_score);
} else {
  // no AI score: keep heuristic score
  if (score === 0) reasons.push('No high-confidence heuristics raised flags');
}

if (score > 100) score = 100;
const verdict = score >= 70 ? 'block' : score >= 40 ? 'warn' : 'safe';

// Build detailed output including all intermediate outputs
const output = {
  url: inputUrl,
  verdict,
  phish_score: score,
  reasons,
  breakdown: {
    safebrowsing: sb,
    phishtank: pt,
    virustotal: vt,
    whois: whois,
    html_snippet: (html || '').toString().slice(0,2000),
    ai: { ai_score: ai_score, ai_explanation }
  },
  raw_ai_response: aiRaw
};

return [{ json: output }];"
      },
      "name": "Scoring & Verdict (blend AI)",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [960, 420]
    },
    {
      "parameters": { "statusCode": 200, "body": "={{ $json }}" },
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1220, 420]
    }
  ],
  "connections": {
    "Webhook Trigger": { "main": [ [ { "node": "Set URL & Hostname", "type": "main", "index": 0 } ] ] },
    "Set URL & Hostname": { "main": [ [ { "node": "Google Safe Browsing", "type": "main", "index": 0 }, { "node": "PhishTank Lookup", "type": "main", "index": 0 }, { "node": "VirusTotal URL Check", "type": "main", "index": 0 }, { "node": "WHOIS / Domain Info (placeholder)", "type": "main", "index": 0 }, { "node": "Fetch Page HTML", "type": "main", "index": 0 } ] ] },
    "Google Safe Browsing": { "main": [ [ { "node": "Scoring & Verdict (blend AI)", "type": "main", "index": 0 } ] ] },
    "PhishTank Lookup": { "main": [ [ { "node": "Scoring & Verdict (blend AI)", "type": "main", "index": 0 } ] ] },
    "VirusTotal URL Check": { "main": [ [ { "node": "Scoring & Verdict (blend AI)", "type": "main", "index": 0 } ] ] },
    "WHOIS / Domain Info (placeholder)": { "main": [ [ { "node": "Scoring & Verdict (blend AI)", "type": "main", "index": 0 } ] ] },
    "Fetch Page HTML": { "main": [ [ { "node": "AI Model Check (OpenAI)", "type": "main", "index": 0 }, { "node": "Scoring & Verdict (blend AI)", "type": "main", "index": 0 } ] ] },
    "AI Model Check (OpenAI)": { "main": [ [ { "node": "Scoring & Verdict (blend AI)", "type": "main", "index": 0 } ] ] },
    "Scoring & Verdict (blend AI)": { "main": [ [ { "node": "Respond to Webhook", "type": "main", "index": 0 } ] ] }
  }
}
